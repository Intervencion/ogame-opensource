# Exdodus

Фича Exodus используется для экспорт/импорта аккаунтов с других серверов.

Для переноса используется файл формата JSON, описанный далее.

## Стартовая страница

При игре раундами (модификация Endgame) игроки выставляют свои аккаунты перед началом раунда.

На главной странице показывается краткая информация о том какие аккаунты будут участвовать в раунде.  (прикольная плашка по типу как в Tracker)

Как только кулдаун завершается - новый раунд начинается с создания Вселенной, при этом выставленные аккаунты импортируются автоматически.

## Админка

В админке в разделе "Пользователи" есть возможность экспорта/импорта аккаунта. Это в случае если админ решит руками добавить кого-то в живой раунд.

## Движок

Весь функционал экспорта/импорта аггрегирован в модуле `game/exodus.php`. Он включает в себя:
- Методы импорта выставленных аккаунтов из мастер базы
- Механику переноса планет, если при импорте место будет занято, а также если в импортируемом аккаунте есть планеты в галактике/системе больше чем во Вселенной куда он переезжает.
- Возможность отправить экспортированный JSON на почту игрока
- Что-то ещё, что может потребоваться для этого процесса

## Конец раунда

Если активна модификация Endgame - в конце раунда подписанные аккаунты экспортируются и отправляются игрокам на почту.

## JSON

Пока тут драфт формата (пример), в виде псевдо-JSON, потом сделаем схему.

```json

{
	"uni": 						// Информация откуда изначально приехал аккаунт. Если аккаунт экспортируется на повторный раунд, то в этом нет особой необходимости
	{
		"title": "Saros OGame",
		"url": "s197-ru.ogame.gameforge.com",
		"mmorpg": "url"   				// Ссылка на mmorpg для проверки аккаунта
	},
	"user":
	{
		"name": "Commodore Zagadra",
		"email": "zagadra_12778@gmail.com",
		"rXX": 11  				// Уровни исследований игрока (XX = ID исследования)
	},
	"planets": [  			// Массив планет. Ресурсы не импортируются, т.к. отслеживать их по mmorpg нет возможности
		{
			"type": 0, 			// 0 - planet, 1 - moon
			"name": "Планета",
			"temp": 123, 			// Температура
			"diam": 12345, 		// Диаметр
			"g": 1,
			"s": 3, 			// Координаты
			"p": 12, 
			"bXX": 22, 				// Постройки (XX = ID постройки)
			"fXX": 22, 				// Флот (XX = ID флота)
			"dXX": 22 				// Оборона (XX = ID обороны)
		},  // ...
	],
	"sign": "xxxxxxxxxx"  				// Подпись
}

```

## Расширение для браузера

Для браузера будет разработан скрипт, который просто краулит аккаунт игрока и формирует JSON для Исхода.

## Подпись и поручители

JSON содержит свойство с подписью всего остального контента. Для подписи используется обычный RSA (`openssl_sign`, SHA1).

Подпись делается с предварительным занулением строки-свойства подписи (все символы заменяются на '0').

Приватный ключ генерируется на сервере и сохраняется в вместе с публичным ключом, с указанием email. Оба ключа хранятся в мастер базе. Ключи формирует и раздаёт доверенным игрокам админ.

Приватный ключ отправляется доверенному пользователю, который устанавливает его в Расширении для браузера, для подписи экспортируемого аккаунта.

При импорте последовательно проверяется подпись публичным ключом для всех ключей в мастер базе и если проверка ок и email совпадает, то импорт разрешён.
